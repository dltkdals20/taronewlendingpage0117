# 오후 9시(21시) 시나리오 상세 설명

## 🕘 오후 9시 (21:00) 시간대별 계산값

### 시간대별 재고 계산 로직
- **21:00 ~ 22:59**: 피크 시작 (3~5개)
  - 21시: `5 - (21 - 21) = 5개`
  - 22시: `5 - (22 - 21) = 4개`

---

## 📊 시나리오 예시

### 시나리오 1: 오후 9시 정각 (21:00)

**상황**:
- 현재 시간: 오후 9시 00분
- Supabase 신청 횟수: 0개

**계산**:
```
시간대별 계산값 = 5개 (21시)
신청 횟수 = 0개
화면 재고 = 5 - 0 = 5개
```

**화면 표시**: "현재 남은 수량: **5개**"

---

### 시나리오 2: 오후 9시에 신청 2건 완료

**상황**:
- 현재 시간: 오후 9시 15분
- Supabase 신청 횟수: 0개 (초기)
- 사용자가 신청하기 2번 완료

**진행 과정**:

1. **초기 상태 (21:00)**
   ```
   시간대별 계산값 = 5개
   신청 횟수 = 0개
   화면 재고 = 5개
   ```

2. **첫 번째 신청 완료**
   - `increment_application_count()` 호출
   - Supabase: 신청 횟수 = 1
   ```
   시간대별 계산값 = 5개
   신청 횟수 = 1개
   화면 재고 = 5 - 1 = 4개 ✅ (즉시 갱신)
   ```

3. **두 번째 신청 완료**
   - `increment_application_count()` 호출
   - Supabase: 신청 횟수 = 2
   ```
   시간대별 계산값 = 5개
   신청 횟수 = 2개
   화면 재고 = 5 - 2 = 3개 ✅ (즉시 갱신)
   ```

**최종 화면 표시**: "현재 남은 수량: **3개**"

---

### 시나리오 3: 오후 8시 59분 → 오후 9시로 넘어갈 때

**상황**:
- 오후 8시 59분: 시간대별 계산값 = 5개 (17:00~20:59 구간)
- 오후 9시 00분: 시간대별 계산값 = 5개 (21:00~22:59 구간)
- Supabase 신청 횟수: 2개

**진행 과정**:

1. **오후 8시 59분**
   ```
   시간대별 계산값 = 5개 (20시 구간)
   신청 횟수 = 2개
   화면 재고 = 5 - 2 = 3개
   ```

2. **오후 9시 00분 (자동 갱신)**
   - `StockDisplay` 컴포넌트가 1분마다 시간대 체크
   - 시간대가 변경되었음을 감지
   - 자동으로 재고 재계산
   ```
   시간대별 계산값 = 5개 (21시 구간) ← 시간대는 바뀌었지만 값은 같음
   신청 횟수 = 2개
   화면 재고 = 5 - 2 = 3개 (동일)
   ```

**결과**: 시간대는 바뀌었지만 계산값이 같아서 화면 재고는 동일하게 유지됨

---

### 시나리오 4: 오후 9시 → 오후 10시로 넘어갈 때

**상황**:
- 오후 9시: 시간대별 계산값 = 5개
- 오후 10시: 시간대별 계산값 = 4개
- Supabase 신청 횟수: 1개

**진행 과정**:

1. **오후 9시 59분**
   ```
   시간대별 계산값 = 5개 (21시 구간)
   신청 횟수 = 1개
   화면 재고 = 5 - 1 = 4개
   ```

2. **오후 10시 00분 (자동 갱신)**
   - 시간대 변경 감지
   - 자동 재계산
   ```
   시간대별 계산값 = 4개 (22시 구간) ← 1개 감소
   신청 횟수 = 1개
   화면 재고 = 4 - 1 = 3개 ✅ (1개 감소)
   ```

**결과**: 시간대 변경으로 계산값이 5→4로 줄어들어, 화면 재고도 4→3으로 자동 감소

---

### 시나리오 5: 오후 9시에 신청이 많아서 재고가 0이 되는 경우

**상황**:
- 현재 시간: 오후 9시 30분
- 시간대별 계산값 = 5개
- Supabase 신청 횟수: 4개
- 화면 재고 = 5 - 4 = 1개

**사용자가 신청 완료**:
- `increment_application_count()` 호출
- Supabase: 신청 횟수 = 5
```
시간대별 계산값 = 5개
신청 횟수 = 5개
화면 재고 = 5 - 5 = 0개 ✅
```

**화면 표시**: "현재 남은 수량: **0개**"

**참고**: `Math.max(0, timeBasedStock - applicationCount)` 로직으로 음수는 방지됨

---

## 🔄 자동 갱신 메커니즘

### 시간대 변경 감지
- `StockDisplay` 컴포넌트가 **1분마다** 현재 시간 체크
- 시간대(시)가 변경되면 자동으로 재고 재계산
- Supabase에서 최신 신청 횟수 가져와서 다시 계산

### 신청 완료 시 즉시 갱신
- 신청 완료 → `increment_application_count()` 호출
- `onStockDecreased` 콜백 → `StockDisplay` 즉시 갱신
- 0.5초 후 다시 계산 (최신 신청 횟수 반영)

---

## 📈 오후 9시 시간대 흐름도

```
21:00 → 5개 (피크 시작)
  ↓
21:30 → 5개 (계산값 동일)
  ↓
22:00 → 4개 (1개 감소)
  ↓
22:30 → 4개 (계산값 동일)
  ↓
23:00 → 3개 (1개 감소)
```

**실제 화면 재고** = 위 계산값 - 신청 횟수

---

## 💡 핵심 포인트

1. **오후 9시 = 피크 시작**
   - 시간대별 계산값: 5개
   - 긴장감 조성 시작

2. **신청 완료 시 즉시 차감**
   - 화면 재고가 바로 업데이트됨
   - 사용자가 "진짜 줄어든다"고 느낌

3. **시간대 변경 시 자동 갱신**
   - 1분마다 체크
   - 시간대가 바뀌면 자동으로 재계산

4. **최소값 보장**
   - 화면 재고는 최소 0개 (음수 방지)
   - 진행 바는 최소 5% 표시
